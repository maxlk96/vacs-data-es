name: AIRAC Tag

on:
  schedule:
    - cron: "0 0 * * *" # Midnight UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Check for AIRAC cycle
        id: check
        shell: bash
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          echo "Checking for AIRAC cycle on $TODAY..."

          # Read YAML file and look for current date
          CYCLE=$(grep "^$TODAY:" .github/airac-cycles.yaml | cut -d '"' -f 2 || true)

          if [[ -n "$CYCLE" ]]; then
            echo "Found AIRAC cycle: $CYCLE"
            echo "cycle_name=$CYCLE" >> "$GITHUB_OUTPUT"
          else
            echo "No AIRAC cycle found for today."
          fi

      - name: Create AIRAC Tag
        if: steps.check.outputs.cycle_name != ''
        env:
          CYCLE: ${{ steps.check.outputs.cycle_name }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          TAG_NAME="airac-$CYCLE"

          # Check if tag exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
             echo "Tag $TAG_NAME already exists, skipping."
             exit 0
          fi

          echo "Creating tag $TAG_NAME"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
